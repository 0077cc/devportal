#!/bin/bash -xe

PROJECT_NAME="devportal"

BASEDIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
BUILD_DIR="$BASEDIR/build"

# Run tests
if [[ ${runTests} == 'true' ]]
then
  echo "Creating site"
  cd $BUILD_DIR/$PROJECT_NAME
  DRUPAL_DB="drupal_db"
  DRUPAL_DB_URL="mysql://root:@127.0.0.1/$DRUPAL_DB"
  php ../composer.phar global require drush/drush:8.x

  mysql -u root -e "CREATE DATABASE $DRUPAL_DB"
  php -d sendmail_path=$(which true) ~/.composer/vendor/bin/drush.php --yes -v site-install "apim_profile" --db-url="$DRUPAL_DB_URL" --account-pass="Qwert123"
  cd $BUILD_DIR/$PROJECT_NAME/sites/default
  mkdir -p $BUILD_DIR/$PROJECT_NAME/sites/default/files
  mkdir -p $BUILD_DIR/$PROJECT_NAME/sites/default/files/bootstrap/provider
  sudo chgrp -R aegir $BUILD_DIR/$PROJECT_NAME/sites/default/files
  sudo chmod -R g+ws $BUILD_DIR/$PROJECT_NAME/sites/default/files

  cd $BUILD_DIR/$PROJECT_NAME/sites/default
  php ~/.composer/vendor/bin/drush.php cache-rebuild
  # need to disable big_pipe or our tests seem to fail
  php ~/.composer/vendor/bin/drush.php pm-uninstall -y big_pipe dynamic_page_cache honeypot

  php ~/.composer/vendor/bin/drush.php -y config-set user.settings verify_mail 0
  php ~/.composer/vendor/bin/drush.php state-set ibm_apim.site_namespace "1234.5678"
  php ~/.composer/vendor/bin/drush.php state-set ibm_apim.site_client_secret foo
  php ~/.composer/vendor/bin/drush.php state-set ibm_apim.site_client_id bar
  php ~/.composer/vendor/bin/drush.php ucon "{\"catalog\":{\"type\":\"catalog\",\"api_version\":\"2.0.0\",\"id\":\"37b2d814-fdfa-44d3-a34e-0bbd2326b671\",\"name\":\"test\",\"title\":\"test\",\"summary\":null,\"shadow_id\":\"e1c8f200-2116-11e8-9c30-6f436fab2280\",\"shadow\":false,\"owner_url\":\"\/api\/user-registries\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/b343e890-0d28-4097-b6f8-69196c101c60\/users\/d1fa58a8-e5c7-4e90-bdfa-027f2d97760c\",\"metadata\":null,\"created_at\":\"2018-03-06T08:17:58.325Z\",\"updated_at\":\"2018-03-06T08:17:58.325Z\",\"org_url\":\"\/api\/orgs\/59c2c2ce-f691-49ff-bca7-69332cde79e0\",\"url\":\"\/api\/catalogs\/59c2c2ce-f691-49ff-bca7-69332cde79e0\/37b2d814-fdfa-44d3-a34e-0bbd2326b671\"},\"catalog_setting\":{\"type\":\"catalog_setting\",\"api_version\":\"2.0.0\",\"name\":\"catalog-setting\",\"title\":null,\"summary\":null,\"shadow_id\":\"e1f77c11-2116-11e8-bea7-af54441cd0b1\",\"shadow\":false,\"application_lifecycle\":{\"enabled\":false},\"consumer_self_service_onboarding\":true,\"custom_notification_templates_enabled\":false,\"email_sender\":{\"custom\":false,\"name\":null,\"address\":null},\"hash_client_secret\":false,\"invitation_ttl\":172800,\"portal\":{\"type\":\"drupal\",\"endpoint\":\"https:\/\/portal.cd.argo-sl.dev.ciondemand.com\/myorg\/test\",\"portal_service_url\":\"\/api\/orgs\/59c2c2ce-f691-49ff-bca7-69332cde79e0\/portal-services\/94bfdd82-df90-430a-8eed-695e3fce66d3\"},\"product_lifecycle_approvals\":null,\"production_mode\":false,\"spaces_enabled\":false,\"task_self_approval\":false,\"user_registry_default_url\":\"\/api\/catalogs\/59c2c2ce-f691-49ff-bca7-69332cde79e0\/37b2d814-fdfa-44d3-a34e-0bbd2326b671\/catalog-user-registries\/c83918a1-a377-45d2-9cbf-41b893a49c46\",\"v5_endpoint_substitution_behavior\":{\"enabled\":null,\"base_endpoints\":null,\"unenforced_api_base_endpoint\":null},\"vanity_api_endpoint\":{\"enabled\":false,\"base_endpoint\":null},\"metadata\":null,\"created_at\":\"2018-03-06T08:17:59.817Z\",\"updated_at\":\"2018-03-06T08:18:29.725Z\",\"org_url\":\"\/api\/orgs\/59c2c2ce-f691-49ff-bca7-69332cde79e0\",\"catalog_url\":\"\/api\/catalogs\/59c2c2ce-f691-49ff-bca7-69332cde79e0\/37b2d814-fdfa-44d3-a34e-0bbd2326b671\",\"url\":\"\/api\/catalogs\/59c2c2ce-f691-49ff-bca7-69332cde79e0\/37b2d814-fdfa-44d3-a34e-0bbd2326b671\/settings\"},\"configured_catalog_user_registries\":[{\"type\":\"configured_catalog_user_registry\",\"api_version\":\"2.0.0\",\"id\":\"c83918a1-a377-45d2-9cbf-41b893a49c46\",\"name\":\"test-catalog\",\"title\":\"test Catalog User Registry\",\"summary\":\"test Catalog User Registry\",\"shadow_id\":\"e1f75500-2116-11e8-88ca-fcb833641144\",\"shadow\":false,\"original_id\":\"6fd14e95-8d07-4ec1-8fdb-a27d20c5141e\",\"owned\":true,\"integration_url\":\"\/api\/cloud\/integrations\/user-registry\/3be0df78-b5cd-4497-a393-782082950613\",\"registry_type\":\"lur\",\"user_managed\":true,\"user_registry_managed\":true,\"onboarding\":\"active\",\"case_sensitive\":true,\"identity_providers\":[{\"name\":\"test-idp\",\"title\":\"test Identity Provider\"}],\"metadata\":{\"id\":\"c84463a4-858a-41b8-9215-58139ac274c2\",\"name\":\"d99e7b91-7139-45b7-9753-4c8e5748182d\"},\"created_at\":\"2018-03-06T08:17:59.690Z\",\"updated_at\":\"2018-03-06T08:17:59.690Z\",\"org_url\":\"\/api\/orgs\/59c2c2ce-f691-49ff-bca7-69332cde79e0\",\"catalog_url\":\"\/api\/catalogs\/59c2c2ce-f691-49ff-bca7-69332cde79e0\/37b2d814-fdfa-44d3-a34e-0bbd2326b671\",\"user_registry_url\":\"\/api\/user-registries\/59c2c2ce-f691-49ff-bca7-69332cde79e0\/6fd14e95-8d07-4ec1-8fdb-a27d20c5141e\",\"url\":\"\/api\/catalogs\/59c2c2ce-f691-49ff-bca7-69332cde79e0\/37b2d814-fdfa-44d3-a34e-0bbd2326b671\/catalog-user-registries\/c83918a1-a377-45d2-9cbf-41b893a49c46\"}],\"permissions\":[{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"d8d1880e-ebd9-4ee2-baeb-2f82ebed70ac\",\"name\":\"member:manage\",\"title\":\"member:manage\",\"shadow_id\":\"b79400c0-2115-11e8-9fa2-22b7048ee06a\",\"shadow\":false,\"permission_type\":\"org\",\"created_at\":\"2018-03-06T08:09:39.270Z\",\"updated_at\":\"2018-03-06T08:09:39.270Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/org\/d8d1880e-ebd9-4ee2-baeb-2f82ebed70ac\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"3e1652f1-e2f5-4d4f-9f58-2e11c312a148\",\"name\":\"member:view\",\"title\":\"member:view\",\"shadow_id\":\"b79204f0-2115-11e8-b8af-cc95ccd1f2d0\",\"shadow\":false,\"permission_type\":\"org\",\"created_at\":\"2018-03-06T08:09:39.255Z\",\"updated_at\":\"2018-03-06T08:09:39.255Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/org\/3e1652f1-e2f5-4d4f-9f58-2e11c312a148\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"752e7ec8-583c-4ae6-8c58-a2e56116e38a\",\"name\":\"settings:manage\",\"title\":\"settings:manage\",\"shadow_id\":\"b78fe210-2115-11e8-a057-d34d49377135\",\"shadow\":false,\"permission_type\":\"org\",\"created_at\":\"2018-03-06T08:09:39.242Z\",\"updated_at\":\"2018-03-06T08:09:39.242Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/org\/752e7ec8-583c-4ae6-8c58-a2e56116e38a\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"b0e7b96f-f49b-4c3b-a0c5-d72042eb4372\",\"name\":\"settings:view\",\"title\":\"settings:view\",\"shadow_id\":\"b78d4a00-2115-11e8-9916-6ce395809341\",\"shadow\":false,\"permission_type\":\"org\",\"created_at\":\"2018-03-06T08:09:39.226Z\",\"updated_at\":\"2018-03-06T08:09:39.226Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/org\/b0e7b96f-f49b-4c3b-a0c5-d72042eb4372\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"01b72da2-ad89-4b2a-b2b2-c245151c7732\",\"name\":\"topology:manage\",\"title\":\"topology:manage\",\"shadow_id\":\"b79894a0-2115-11e8-8a44-e039ad7013d4\",\"shadow\":false,\"permission_type\":\"org\",\"created_at\":\"2018-03-06T08:09:39.298Z\",\"updated_at\":\"2018-03-06T08:09:39.298Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/org\/01b72da2-ad89-4b2a-b2b2-c245151c7732\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"e9b21e62-96ad-4bca-b00d-702bf00d06f6\",\"name\":\"topology:view\",\"title\":\"topology:view\",\"shadow_id\":\"b7964ab0-2115-11e8-a153-94653a7db269\",\"shadow\":false,\"permission_type\":\"org\",\"created_at\":\"2018-03-06T08:09:39.284Z\",\"updated_at\":\"2018-03-06T08:09:39.284Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/org\/e9b21e62-96ad-4bca-b00d-702bf00d06f6\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"e120f488-5921-45a8-a936-d34d4686ab8c\",\"name\":\"view\",\"title\":\"view\",\"shadow_id\":\"b79d0170-2115-11e8-82f3-9653f352898b\",\"shadow\":false,\"permission_type\":\"org\",\"created_at\":\"2018-03-06T08:09:39.313Z\",\"updated_at\":\"2018-03-06T08:09:39.313Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/org\/e120f488-5921-45a8-a936-d34d4686ab8c\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"81c86a24-c9e1-4fb5-a4e2-a137eef079c7\",\"name\":\"app-analytics:view\",\"title\":\"app-analytics:view\",\"shadow_id\":\"b7eb2170-2115-11e8-aed8-b3f0b37e9153\",\"shadow\":false,\"permission_type\":\"consumer\",\"created_at\":\"2018-03-06T08:09:39.842Z\",\"updated_at\":\"2018-03-06T08:09:39.842Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/consumer\/81c86a24-c9e1-4fb5-a4e2-a137eef079c7\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"e63e4ebc-8787-4901-8f42-16dba9aa8edd\",\"name\":\"app-dev:manage\",\"title\":\"app-dev:manage\",\"shadow_id\":\"b7e4dfe0-2115-11e8-8dbf-eea0bddc70dc\",\"shadow\":false,\"permission_type\":\"consumer\",\"created_at\":\"2018-03-06T08:09:39.801Z\",\"updated_at\":\"2018-03-06T08:09:39.801Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/consumer\/e63e4ebc-8787-4901-8f42-16dba9aa8edd\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"47d90d81-5080-4882-b270-778334fdbf50\",\"name\":\"app:manage\",\"title\":\"app:manage\",\"shadow_id\":\"b7e61860-2115-11e8-9233-6810ca326298\",\"shadow\":false,\"permission_type\":\"consumer\",\"created_at\":\"2018-03-06T08:09:39.810Z\",\"updated_at\":\"2018-03-06T08:09:39.810Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/consumer\/47d90d81-5080-4882-b270-778334fdbf50\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"e20ca0b3-a2f0-419f-9a99-177c6050c98d\",\"name\":\"app:view\",\"title\":\"app:view\",\"shadow_id\":\"b7e3a760-2115-11e8-ad7a-deb6f2d419a3\",\"shadow\":false,\"permission_type\":\"consumer\",\"created_at\":\"2018-03-06T08:09:39.794Z\",\"updated_at\":\"2018-03-06T08:09:39.794Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/consumer\/e20ca0b3-a2f0-419f-9a99-177c6050c98d\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"2c9d4ee3-9348-4159-972f-69ea1ffda5ab\",\"name\":\"product:view\",\"title\":\"product:view\",\"shadow_id\":\"b7e247d0-2115-11e8-93a6-fa8174340361\",\"shadow\":false,\"permission_type\":\"consumer\",\"created_at\":\"2018-03-06T08:09:39.785Z\",\"updated_at\":\"2018-03-06T08:09:39.785Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/consumer\/2c9d4ee3-9348-4159-972f-69ea1ffda5ab\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"bc1a91ee-ed73-4a79-bfa1-3dae1f277d08\",\"name\":\"subscription:manage\",\"title\":\"subscription:manage\",\"shadow_id\":\"b7e99ad0-2115-11e8-9d29-a971869a16d8\",\"shadow\":false,\"permission_type\":\"consumer\",\"created_at\":\"2018-03-06T08:09:39.831Z\",\"updated_at\":\"2018-03-06T08:09:39.831Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/consumer\/bc1a91ee-ed73-4a79-bfa1-3dae1f277d08\"},{\"type\":\"permission\",\"api_version\":\"2.0.0\",\"id\":\"04ee1b04-4f3a-4061-8b99-5fce9a4f346c\",\"name\":\"subscription:view\",\"title\":\"subscription:view\",\"shadow_id\":\"b7e79f00-2115-11e8-9162-a9cec62e6f8e\",\"shadow\":false,\"permission_type\":\"consumer\",\"created_at\":\"2018-03-06T08:09:39.819Z\",\"updated_at\":\"2018-03-06T08:09:39.819Z\",\"url\":\"\/consumer-api\/consumer\/permissions\/consumer\/04ee1b04-4f3a-4061-8b99-5fce9a4f346c\"}],\"analytics\":[{\"type\":\"analytics_service\",\"api_version\":\"2.0.0\",\"id\":\"64dc45fd-09be-424d-80ef-6ceaec4acf7d\",\"name\":\"analytics\",\"title\":\"analytics\",\"shadow_id\":\"5c3849b0-2116-11e8-b54c-4da2bab06e10\",\"availability_zone_url\":\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/availability-zones\/c195918c-5204-4fc1-834d-c94e8dd4a599\",\"client_endpoint\":\"https:\/\/cd-a7s-client.argo-sl.dev.ciondemand.com\",\"client_endpoint_tls_client_profile_url\":\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/tls-client-profiles\/fd9f8d22-0fd3-4a4a-bb27-a7fdc5c23222\",\"endpoint\":\"https:\/\/cd-a7s-client.argo-sl.dev.ciondemand.com\",\"ingestion_endpoint\":\"https:\/\/cd-a7s-in.argo-sl.dev.ciondemand.com\",\"ingestion_endpoint_tls_client_profile_url\":\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/tls-client-profiles\/0143eb89-f769-4811-8c5a-5b743b2a5cc7\",\"shadow\":false,\"created_at\":\"2018-03-06T08:14:15.330Z\",\"updated_at\":\"2018-03-06T08:14:15.330Z\",\"org_url\":\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\",\"url\":\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/availability-zones\/c195918c-5204-4fc1-834d-c94e8dd4a599\/analytics-services\/64dc45fd-09be-424d-80ef-6ceaec4acf7d\"}],\"tls_client_profiles\":[{\"type\":\"tls_client_profile\",\"api_version\":\"2.0.0\",\"id\":\"fd9f8d22-0fd3-4a4a-bb27-a7fdc5c23222\",\"name\":\"analytics-client-default\",\"version\":\"1.0.0\",\"title\":\"Analytics client TLS client profile\",\"summary\":\"Default TLS client profile for analytics client\",\"shadow_id\":\"ba8469f0-2115-11e8-a3d6-17427384944e\",\"shadow\":false,\"protocols\":[\"tls_v1.2\"],\"ciphers\":[\"ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\",\"ECDHE_RSA_WITH_AES_256_GCM_SHA384\",\"ECDHE_ECDSA_WITH_AES_256_CBC_SHA384\",\"ECDHE_RSA_WITH_AES_256_CBC_SHA384\",\"ECDHE_ECDSA_WITH_AES_256_CBC_SHA\",\"ECDHE_RSA_WITH_AES_256_CBC_SHA\",\"DHE_DSS_WITH_AES_256_GCM_SHA384\",\"DHE_RSA_WITH_AES_256_GCM_SHA384\",\"DHE_RSA_WITH_AES_256_CBC_SHA256\",\"DHE_DSS_WITH_AES_256_CBC_SHA256\",\"DHE_RSA_WITH_AES_256_CBC_SHA\",\"DHE_DSS_WITH_AES_256_CBC_SHA\",\"RSA_WITH_AES_256_GCM_SHA384\",\"RSA_WITH_AES_256_CBC_SHA256\",\"RSA_WITH_AES_256_CBC_SHA\",\"ECDHE_ECDSA_WITH_AES_128_GCM_SHA256\",\"ECDHE_RSA_WITH_AES_128_GCM_SHA256\",\"ECDHE_ECDSA_WITH_AES_128_CBC_SHA256\",\"ECDHE_RSA_WITH_AES_128_CBC_SHA256\",\"ECDHE_ECDSA_WITH_AES_128_CBC_SHA\",\"ECDHE_RSA_WITH_AES_128_CBC_SHA\",\"DHE_DSS_WITH_AES_128_GCM_SHA256\",\"DHE_RSA_WITH_AES_128_GCM_SHA256\",\"DHE_RSA_WITH_AES_128_CBC_SHA256\",\"DHE_DSS_WITH_AES_128_CBC_SHA256\",\"DHE_RSA_WITH_AES_128_CBC_SHA\",\"DHE_DSS_WITH_AES_128_CBC_SHA\",\"RSA_WITH_AES_128_GCM_SHA256\",\"RSA_WITH_AES_128_CBC_SHA256\",\"RSA_WITH_AES_128_CBC_SHA\",\"ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA\",\"ECDHE_RSA_WITH_3DES_EDE_CBC_SHA\",\"DHE_RSA_WITH_3DES_EDE_CBC_SHA\",\"DHE_DSS_WITH_3DES_EDE_CBC_SHA\",\"RSA_WITH_3DES_EDE_CBC_SHA\"],\"elliptic_curve\":[\"secp521r1\",\"secp384r1\",\"secp256k1\",\"secp256r1\"],\"insecure_server_connections\":false,\"server_name_indication\":true,\"owned\":true,\"keystore_url\":\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/keystores\/07dfbd3c-f522-4cfd-a8e8-f89ad90667e7\",\"truststore_url\":\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/truststores\/a6e6146c-c6d3-41b7-bae2-ac776b935a10\",\"visibility\":{\"type\":\"private\"},\"created_at\":\"2018-03-06T08:09:44.168Z\",\"updated_at\":\"2018-03-06T08:09:44.168Z\",\"org_url\":\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\",\"url\":\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/tls-client-profiles\/fd9f8d22-0fd3-4a4a-bb27-a7fdc5c23222\",\"keystore\":{\"type\":\"keystore\",\"api_version\":\"2.0.0\",\"id\":\"07dfbd3c-f522-4cfd-a8e8-f89ad90667e7\",\"name\":\"analytics-client-default-keystore\",\"title\":\"Analytics client keystore\",\"summary\":\"Default keystore for analytics client\",\"shadow_id\":\"ba657040-2115-11e8-af03-0a95ae10681f\",\"shadow\":false,\"private_key_entry\":\"-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAvBa3UgO\/bVQkUuFrq3X7w3wd8BK088TglXb8QaLObJc5LufI\n\/JFKm\/BSTHsrrAZ12hv9ZQKNKfDs6XInp5pO30Mu+QIsbbLHS\/XCgKPwI4Zxm7Db\nH1sfhx\/FZxW5o5UE\/Ar28Jp4spC4tzqShKT0dkEK07dL60Ub6lZDcPjNY473mKPz\nfLwsZ2miVtqUr4yHYKnFBxjlFbaU4H2XSHbs+na7EyEN53shKnFxtkdvtCbyT6+I\ndqsdeV722v1V7KP4OkY6Au+Iguwf4yM5Bi6ThH1o9fKwQti4y9Acc4HmQQpowRo0\nfCSSA82EZWIu7GioLepvwq6hF\/sPOdlNO36WBwIDAQABAoIBAQCOaFScUCIb0N0\/\ns1UmGMpqFAtGvaMr\/iBcih4sQ+wu48Bz9yKBuC\/ZKXfmWEuUj7+jSBXu6KOg4b0+\ncyP7DiYxfFiQSEkDNZ0Xshd19qnW+\/AAhUMi1odkc3WuuxA2\/pkri9G0EgDYkiKI\n+Fv++jXtYwmjiuB8XXLpVi7x1i8L9OCJW3feyQbziLUxp04ywv7M3hhBcIZtPNP2\n\/9c4lRt6c55TeJEGvLkK9X1zKiuE+EY31BcE94QLqlfLzm1zDHybSJpXZS7Fzkuv\n7jDCUA+Ns8Hwv45cKb556lRczTigkDvCCjOekN54f9OfClqC5mkAkiJPaiwaJT8U\nS8yg4i1hAoGBAMMslNXlk\/q9HhZ99FpvbNyC38P9tsemvEaZ\/qWBzM2XdkL\/OwMM\nj3LpSVM23IijX3pZ44GPb\/wgYahRRquBTbivm54do2G8Cx4mgJ47ZindlUvJuU1R\nvL6BvkZ3D4CLUm\/JEgvBbxAYEQ+GwigAB1tzqLPiK8E5xOin6UpmVSozAoGBAPa0\n2FwWe09rr0fGWB9+ldNwaMHpNNaj2mpnfsSURIbx1YUQILXbCRGUzi6CL1SxYEng\npyemAWdfZSy+jZI+9SyebifAZrh1IYKFF3z4I26jEmFK122SPb8gEc2x0N2J7D52\nRyehsdQsFzIypevSGsi9VgvbfnXv\/lei8rWwSjjdAoGAVJqptgL737BFL6jP2Lf+\nb6RHzZTYu7kaWlx810\/p8KEcgbRT52F1eXGI+IqKlKyFQetfRJViDOAYlTcONGAr\nychN4\/+jCEXUZ\/B2xqCnC7Ti9+Rs8Ahjkg155t\/Ll4RNaum1aeUi+M4F7z4SQfap\nOcpsMfXz06HwKo5HAZpUhqMCgYAOwaJvX6jgh0BkuqhqudecXgzmDFzsucBGvQoI\nGBZBPBXZb62FMyTHuG7cuUy7dCCeSqG07WkIFdynYH53UOy5ToCoQAnk3pyygeN1\nxiHYbEidKSzZkPXAiNqHwysLFUTcN5bp9\/H7DugUSJNEF70iZLDQ5MAbrc84zrZV\nx8WowQKBgBhLdITWfWKqJR1MwaI9u3pNpH+swWa+5FR3SXnu1pbmdadF2ru99zj5\n3xCTSJP6Kj+zBuNPwmbrVVU\/ElWd8rXVEIHsqyfM66ZJIoTmkoNVdn0Z7UK3sAg9\ndsibeJ0Pqy8TtLbY+0gm2zLS1LG3CxH6iblOMEN\/+wKSrd0DSbr1\n-----END RSA PRIVATE KEY-----\n\",\"public_certificate_entry\":{\"pem\":\"-----BEGIN CERTIFICATE-----\nMIIDWTCCAkGgAwIBAgIRAKSRqXgYQAq7E12MkBp20zwwDQYJKoZIhvcNAQELBQAw\nMDEWMBQGA1UEChMNaW5ncmVzcy1jYSBDQTEWMBQGA1UEAxMNaW5ncmVzcy1jYSBD\nQTAeFw0xODAzMDYwODA3NDBaFw0xOTAzMDYwODA3NDBaMFwxLDAqBgNVBAoTI2Fu\nYWx5dGljcy1jbGllbnQtY2xpZW50IGNlcnRpZmljYXRlMSwwKgYDVQQDEyNhbmFs\neXRpY3MtY2xpZW50LWNsaWVudCBjZXJ0aWZpY2F0ZTCCASIwDQYJKoZIhvcNAQEB\nBQADggEPADCCAQoCggEBALwWt1IDv21UJFLha6t1+8N8HfAStPPE4JV2\/EGizmyX\nOS7nyPyRSpvwUkx7K6wGddob\/WUCjSnw7OlyJ6eaTt9DLvkCLG2yx0v1woCj8COG\ncZuw2x9bH4cfxWcVuaOVBPwK9vCaeLKQuLc6koSk9HZBCtO3S+tFG+pWQ3D4zWOO\n95ij83y8LGdpolbalK+Mh2CpxQcY5RW2lOB9l0h27Pp2uxMhDed7ISpxcbZHb7Qm\n8k+viHarHXle9tr9Veyj+DpGOgLviILsH+MjOQYuk4R9aPXysELYuMvQHHOB5kEK\naMEaNHwkkgPNhGViLuxoqC3qb8KuoRf7DznZTTt+lgcCAwEAAaNCMEAwDgYDVR0P\nAQH\/BAQDAgWgMBMGA1UdJQQMMAoGCCsGAQUFBwMCMAwGA1UdEwEB\/wQCMAAwCwYD\nVR0RBAQwAoIAMA0GCSqGSIb3DQEBCwUAA4IBAQCET+9M7MnCGD5U5b6kgbwQTBTh\njogsAvBX40d8n7EP6E4sRPzOCoAc72\/bVsyPxPpKZK1DDSADtcnKSQZBvemsGjAN\nV3e2enYwQNe++9kF0bSRSi58phKchDCZPSXX\/yLzlvyiTLNazpd93wRLkLvzuqGc\nxLIadSjxSqkoNwC9K2H+\/PWcwIRW+lsHJM\/z\/F4FUrO0KigSO0SfbuID12Ao4Oe\/\naYRgVifkyo\/3Y4BcNID7Hp9wE0JKYJ1Mf5PZ4h3otI3jaidxC5GI4RVpkOq\/OB0q\nns\/rJNwXyL+xFE0ALj5Y3WQt4+A24IlTJa39bEoGHLgeCy9ElRzPWELBBfMw\n-----END CERTIFICATE-----\n\",\"certificate_info\":\"{\\\"version\\\":2,\\\"subject\\\":{\\\"organizationName\\\":\\\"analytics-client-client certificate\\\",\\\"commonName\\\":\\\"analytics-client-client certificate\\\"},\\\"issuer\\\":{\\\"organizationName\\\":\\\"ingress-ca CA\\\",\\\"commonName\\\":\\\"ingress-ca CA\\\"},\\\"serial\\\":\\\"A491A97818400ABB135D8C901A76D33C\\\",\\\"notBefore\\\":\\\"2018-03-06T08:07:40.000Z\\\",\\\"notAfter\\\":\\\"2019-03-06T08:07:40.000Z\\\",\\\"subjectHash\\\":\\\"d820df8d\\\",\\\"signatureAlgorithm\\\":\\\"sha256WithRSAEncryption\\\",\\\"fingerPrint\\\":\\\"AF:1D:5A:09:A6:0D:CD:97:20:30:61:8E:B3:BA:40:C7:B1:AE:05:58\\\",\\\"publicKey\\\":{\\\"algorithm\\\":\\\"rsaEncryption\\\",\\\"e\\\":\\\"65537\\\",\\\"n\\\":\\\"BC16B75203BF6D542452E16BAB75FBC37C1DF012B4F3C4E09576FC41A2CE6C97392EE7C8FC914A9BF0524C7B2BAC0675DA1BFD65028D29F0ECE97227A79A4EDF432EF9022C6DB2C74BF5C280A3F02386719BB0DB1F5B1F871FC56715B9A39504FC0AF6F09A78B290B8B73A9284A4F476410AD3B74BEB451BEA564370F8CD638EF798A3F37CBC2C6769A256DA94AF8C8760A9C50718E515B694E07D974876ECFA76BB13210DE77B212A7171B6476FB426F24FAF8876AB1D795EF6DAFD55ECA3F83A463A02EF8882EC1FE32339062E93847D68F5F2B042D8B8CBD01C7381E6410A68C11A347C249203CD8465622EEC68A82DEA6FC2AEA117FB0F39D94D3B7E9607\\\",\\\"bitSize\\\":2048},\\\"altNames\\\":[\\\"\\\"],\\\"extensions\\\":{\\\"keyUsage\\\":\\\"Digital Signature, Key Encipherment\\\",\\\"extendedKeyUsage\\\":\\\"TLS Web Client Authentication\\\",\\\"basicConstraints\\\":\\\"CA:FALSE\\\",\\\"subjectAlternativeName\\\":\\\"DNS:\\\"},\\\"fingerprints\\\":{\\\"sha1\\\":{\\\"fingerprint\\\":\\\"AF:1D:5A:09:A6:0D:CD:97:20:30:61:8E:B3:BA:40:C7:B1:AE:05:58\\\"},\\\"md5\\\":{\\\"fingerprint\\\":\\\"D6:EB:15:2B:07:B8:75:B1:3F:4F:39:92:14:16:FC:4B\\\"},\\\"sha256\\\":{\\\"fingerprint\\\":\\\"AE:D2:89:25:41:DF:D2:92:22:6A:30:FC:1D:60:4C:11:EB:F8:40:06:B1:E3:B6:11:ED:7E:E1:9F:10:74:9D:4E\\\"}}}\"},\"created_at\":\"2018-03-06T08:09:43.950Z\",\"updated_at\":\"2018-03-06T08:09:43.950Z\",\"url\":\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/keystores\/07dfbd3c-f522-4cfd-a8e8-f89ad90667e7\"},\"truststore\":{\"type\":\"truststore\",\"api_version\":\"2.0.0\",\"id\":\"a6e6146c-c6d3-41b7-bae2-ac776b935a10\",\"name\":\"analytics-client-default-truststore\",\"title\":\"Analytics client truststore\",\"summary\":\"Default truststore for analytics client\",\"shadow_id\":\"ba68a490-2115-11e8-bf31-7f453cc1f7f6\",\"shadow\":false,\"entry_urls\":[\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/truststores\/a6e6146c-c6d3-41b7-bae2-ac776b935a10\/entries\/73be5bbd-aaa9-4403-b4f6-df88b4f7dc7c\",\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/truststores\/a6e6146c-c6d3-41b7-bae2-ac776b935a10\/entries\/ae6c07f8-1522-477f-aba8-925a6a5dbfaa\"],\"created_at\":\"2018-03-06T08:09:44.018Z\",\"updated_at\":\"2018-03-06T08:09:44.018Z\",\"url\":\"\/api\/orgs\/68935f56-acf8-4705-8c09-e3c73f9adf8d\/truststores\/a6e6146c-c6d3-41b7-bae2-ac776b935a10\",\"entries\":[\"-----BEGIN CERTIFICATE-----\nMIIDAjCCAeqgAwIBAgIRAM611iadytS15xW8G+iHdPIwDQYJKoZIhvcNAQELBQAw\nKjETMBEGA1UEChMKcm9vdC1jYSBDQTETMBEGA1UEAxMKcm9vdC1jYSBDQTAeFw0x\nODAzMDYwODA3MzdaFw0xOTAzMDYwODA3MzdaMCoxEzARBgNVBAoTCnJvb3QtY2Eg\nQ0ExEzARBgNVBAMTCnJvb3QtY2EgQ0EwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAw\nggEKAoIBAQDRaYCL5DSWyeMNB59PX0DxY\/Okc+zxeu4bEYs8PRtzt8ZlL6ognYNC\n\/HBr6sdaKdjMQ1Ri0h1dGWOJCoy5XIcBRxRmYopXn8syAnd5ReQyX4FzfmWw1hgg\nfDCOXRQuuEUE1GIY4wBaowWXZ78AbFgxazjZWI1hTzlCg9lKHPffc8faxGr6dXov\nyZpG\/n\/XJ\/fLjQkWo1QNyRiae343qwJR8tYhF+ltVXWzqhfumP2SSd3+RuvOQTg6\nzL6W+lAY6zU80M6XkxK6uNzwPEg0MagWWAeGqw2VmOiJ+pVUByVYnFpavMg8\/2mT\nK0PK2ggMkeyaK9sDBTTTtFjoL\/YiNwspAgMBAAGjIzAhMA4GA1UdDwEB\/wQEAwIC\npDAPBgNVHRMBAf8EBTADAQH\/MA0GCSqGSIb3DQEBCwUAA4IBAQBF3jQasCBz6Lkh\nDFND3E3W8nBzJtnvJ4Qc9ANbBekzS9crDTMkChPCLZX7K6IUHA1ahysQg0Hf9wrG\nkTUWqejUGM7ODQRsVCvnlTxTt4dWk2VAyiSJyMM\/m3WwdaXr7fc9QEu2NHA391qN\nsjVhiAK+OuG8ySuoQkQdWUTe+7C2KJpYB1YigeEvm0YcFZx2eD5cnTyNrLP93c0v\nRQITFz\/\/TOeRROSMz9g7248TcyZVWxv4UYj92MzygYFZEFO7NcgdottbULnw2lwv\nErRFmS09Nvz6V3d\/502g8zTxndCUqn4LbH9PCRFzltzg6H3qEAEOdaHXFg9sPMO1\nVDc69qao\n-----END CERTIFICATE-----\n\",\"-----BEGIN CERTIFICATE-----\nMIIDCDCCAfCgAwIBAgIRAJQlzBmNdLCLFL4p6LpmB9MwDQYJKoZIhvcNAQELBQAw\nKjETMBEGA1UEChMKcm9vdC1jYSBDQTETMBEGA1UEAxMKcm9vdC1jYSBDQTAeFw0x\nODAzMDYwODA3MzdaFw0xOTAzMDYwODA3MzdaMDAxFjAUBgNVBAoTDWluZ3Jlc3Mt\nY2EgQ0ExFjAUBgNVBAMTDWluZ3Jlc3MtY2EgQ0EwggEiMA0GCSqGSIb3DQEBAQUA\nA4IBDwAwggEKAoIBAQCp8CAvqMBZopcSuUPGM9kywWuvRKIBcVjrUUZXRYrRwQV6\nkEIDKi4hZA6WgAFliWqlcFRFkeJ99NjakJo49UARVGhA2giyJsgf1QQVid5r0yW+\nK\/qoKG9dMriun4pgl261AU0ZTaxghjAFCkFpyIR8RsNNUz6Y\/fPbZ3vD1q1ezfb1\nluyBbtAp8RFIkZeajo6m5wFZLIyNLRv1zDSsLsB7+Z\/Jd2dTes2rjds5z6KsgdCC\nAkX4i5BWbH1b4frSkSj1LKMdHHQxi\/nulX\/4LCDIjaOKzU\/CgvXhnx\/CZVNf1cPD\nocfJHAxl+wDUQonS47B11\/8OQlLQMGojvS8E0eWZAgMBAAGjIzAhMA4GA1UdDwEB\n\/wQEAwICpDAPBgNVHRMBAf8EBTADAQH\/MA0GCSqGSIb3DQEBCwUAA4IBAQDBv5xw\n6zemvSE6HfqsNnQIO9gMNLMguK7bfo9inwpZhLkNtBFVX3a7xE2itV0zkc2UlWi\/\nejbj7qMLedoU7WMY\/8D2BZRRvKIZPWTWchrt6lThonl1PItZhJh+oeNBXMruksfL\nar4\/Wcl0\/1cdSuhH9BmfehVysnxl7MraIPzyy5VGNzkdBpqq8qThhNtGXnJa\/rmp\nVIC3fZpBKqCyMN54PkYvcu+8TQBnAv1TkCdxd0OxVheCS8YdrDFu2\/X1fvXADtfQ\nJmzHwdHKQG8hk6SD044JwIHZnYDsYdbPqXCGEaGmCrFhLrcSqCOB0+DYY5VUT75s\nSMBOk3JeuB7SEuus\n-----END CERTIFICATE-----\n\"]}}]}"

  echo "Running test setup"
  cd $BUILD_DIR/$PROJECT_NAME
  chmod a+x modules/apictest/setupbehat.sh
  chmod a+x modules/apictest/runbehat.sh
  # capture response of the tests so we can get the logs if we need to
  set +e
  . modules/apictest/setupbehat.sh jenkins

  echo "Running standard behat tests"
  ./runbehat.sh
# TODO: need to tot up all response codes - just remove the ldap tests for the time being.
#  echo "Running ldap behat tests"
#  ./runbehat.sh -p ldap

  if [[ $? -ne 0 ]]
  then
    php ~/.composer/vendor/bin/drush.php -y en dblog
    echo "Dumping dblog"
    cd $BUILD_DIR/$PROJECT_NAME/sites/default
    php ~/.composer/vendor/bin/drush.php watchdog-show --count=1000 --extended
    exit 1
  fi

else
  echo "Skipping tests as requested"
fi
